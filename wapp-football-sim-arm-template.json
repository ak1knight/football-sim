{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "subscriptionId": {
            "type": "string"
        },
        "name": {
            "type": "string"
        },
        "location": {
            "type": "string"
        },
        "hostingPlanName": {
            "type": "string"
        },
        "serverFarmResourceGroup": {
            "type": "string"
        },
        "databaseName": {
            "type": "string"
        },
        "ftpsState": {
            "type": "string"
        },
        "autoGeneratedDomainNameLabelScope": {
            "type": "string"
        },
        "sku": {
            "type": "string"
        },
        "skuCode": {
            "type": "string"
        },
        "workerSize": {
            "type": "string"
        },
        "workerSizeId": {
            "type": "string"
        },
        "numberOfWorkers": {
            "type": "string"
        },
        "linuxFxVersion": {
            "type": "string"
        },
        "accountName": {
            "type": "string"
        },
        "databaseKind": {
            "type": "string"
        },
        "defaultExperience": {
            "type": "string"
        },
        "isZoneRedundant": {
            "type": "string"
        },
        "databaseAccountType": {
            "type": "string"
        },
        "backupPolicyType": {
            "type": "string"
        },
        "backupIntervalInMinutes": {
            "type": "int"
        },
        "backupRetentionIntervalInHours": {
            "type": "int"
        },
        "backupStorageRedundancy": {
            "type": "string"
        },
        "isVirtualNetworkFilterEnabled": {
            "type": "string"
        },
        "enableFreeTier": {
            "type": "string"
        },
        "capabilities": {
            "type": "array"
        },
        "isVnetEnabled": {
            "type": "bool"
        },
        "isPrivateEndpointForAppEnabled": {
            "type": "bool"
        },
        "vnetName": {
            "type": "string"
        },
        "privateEndpointSubnet": {
            "type": "string"
        },
        "subnetForApp": {
            "type": "string"
        },
        "subnetForDb": {
            "type": "string"
        },
        "privateEndpointNameForApp": {
            "type": "string"
        },
        "privateEndpointNameForDb": {
            "type": "string"
        },
        "privateEndpointNameForCache": {
            "type": "string"
        },
        "privateDnsZoneNameForApp": {
            "type": "string"
        },
        "privateDnsZoneNameForDb": {
            "type": "string"
        },
        "privateDnsZoneNameForCache": {
            "type": "string"
        },
        "isCacheEnabled": {
            "type": "bool"
        },
        "cacheName": {
            "type": "string"
        }
    },
    "resources": [
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('resourcesDeploymentApiVersion')]",
            "name": "[variables('databaseResourcesDeployment')]",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "condition": "[parameters('isVnetEnabled')]",
                            "type": "Microsoft.Resources/deployments",
                            "apiVersion": "[variables('resourcesDeploymentApiVersion')]",
                            "name": "[concat(variables('databaseResourcesDeployment'), '-vnet')]",
                            "properties": {
                                "mode": "Incremental",
                                "template": {
                                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                    "contentVersion": "1.0.0.0",
                                    "parameters": {},
                                    "variables": {},
                                    "resources": [
                                        {
                                            "apiVersion": "[variables('privateEndpointApiVersion')]",
                                            "name": "[parameters('privateEndpointNameForDb')]",
                                            "location": "[parameters('location')]",
                                            "type": "Microsoft.Network/privateEndpoints",
                                            "properties": {
                                                "subnet": {
                                                    "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('privateEndpointSubnet'))]"
                                                },
                                                "privateLinkServiceConnections": [
                                                    {
                                                        "name": "[parameters('privateEndpointNameForDb')]",
                                                        "properties": {
                                                            "privateLinkServiceId": "[resourceId('Microsoft.DocumentDb/databaseAccounts/', parameters('accountName'))]",
                                                            "groupIds": [
                                                                "MongoDB"
                                                            ]
                                                        }
                                                    }
                                                ]
                                            },
                                            "resources": [
                                                {
                                                    "type": "privateDnsZoneGroups",
                                                    "apiVersion": "[variables('privateEndpointApiVersion')]",
                                                    "name": "default",
                                                    "location": "[parameters('location')]",
                                                    "properties": {
                                                        "privateDnsZoneConfigs": [
                                                            {
                                                                "name": "database-config",
                                                                "properties": {
                                                                    "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDnsZoneNameForDb'))]"
                                                                }
                                                            }
                                                        ]
                                                    },
                                                    "dependsOn": [
                                                        "[resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointNameForDb'))]"
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                }
                            },
                            "dependsOn": [
                                "[concat('Microsoft.DocumentDb/databaseAccounts/', parameters('accountName'))]"
                            ]
                        },
                        {
                            "apiVersion": "[variables('databaseApiVersion')]",
                            "location": "[parameters('location')]",
                            "name": "[parameters('accountName')]",
                            "type": "Microsoft.DocumentDB/databaseAccounts",
                            "kind": "MongoDB",
                            "tags": {
                                "hidden-cosmos-mmspecial": "",
                                "defaultExperience": "[parameters('defaultExperience')]"
                            },
                            "properties": {
                                "databaseAccountOfferType": "[parameters('databaseAccountType')]",
                                "locations": [
                                    {
                                        "failoverPriority": 0,
                                        "locationName": "[parameters('location')]"
                                    }
                                ],
                                "backupPolicy": {
                                    "type": "[parameters('backupPolicyType')]",
                                    "periodicModeProperties": {
                                        "backupIntervalInMinutes": "[parameters('backupIntervalInMinutes')]",
                                        "backupRetentionIntervalInHours": "[parameters('backupRetentionIntervalInHours')]",
                                        "backupStorageRedundancy": "[parameters('backupStorageRedundancy')]"
                                    }
                                },
                                "isVirtualNetworkFilterEnabled": "[parameters('isVirtualNetworkFilterEnabled')]",
                                "virtualNetworkRules": [],
                                "ipRules": [],
                                "dependsOn": [],
                                "capabilities": "[parameters('capabilities')]",
                                "apiProperties": {
                                    "serverVersion": "[variables('databaseVersion')]"
                                },
                                "enableFreeTier": "[parameters('enableFreeTier')]"
                            },
                            "resources": [
                                {
                                    "dependsOn": [
                                        "[concat('Microsoft.DocumentDB/databaseAccounts', '/', parameters('accountName'))]"
                                    ],
                                    "name": "[parameters('databaseName')]",
                                    "type": "mongodbDatabases",
                                    "apiVersion": "[variables('databaseApiVersion')]",
                                    "properties": {
                                        "resource": {
                                            "id": "[parameters('databaseName')]"
                                        }
                                    }
                                }
                            ]
                        }
                    ]
                }
            },
            "dependsOn": [
                "[concat('Microsoft.Resources/deployments', '/', variables('vnetResourcesDeployment'))]"
            ]
        },
        {
            "condition": "[parameters('isCacheEnabled')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('resourcesDeploymentApiVersion')]",
            "name": "[variables('cacheResourcesDeployment')]",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "apiVersion": "[variables('privateEndpointApiVersion')]",
                            "name": "[parameters('privateEndpointNameForCache')]",
                            "location": "[parameters('location')]",
                            "type": "Microsoft.Network/privateEndpoints",
                            "properties": {
                                "subnet": {
                                    "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('privateEndpointSubnet'))]"
                                },
                                "privateLinkServiceConnections": [
                                    {
                                        "name": "[parameters('privateEndpointNameForCache')]",
                                        "properties": {
                                            "privateLinkServiceId": "[resourceId('Microsoft.Cache/Redis/', parameters('cacheName'))]",
                                            "groupIds": [
                                                "redisCache"
                                            ]
                                        }
                                    }
                                ]
                            },
                            "resources": [
                                {
                                    "type": "privateDnsZoneGroups",
                                    "apiVersion": "[variables('privateEndpointApiVersion')]",
                                    "name": "default",
                                    "location": "[parameters('location')]",
                                    "properties": {
                                        "privateDnsZoneConfigs": [
                                            {
                                                "name": "privatelink-redis-cache-windows-net",
                                                "properties": {
                                                    "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDnsZoneNameForCache'))]"
                                                }
                                            }
                                        ]
                                    },
                                    "dependsOn": [
                                        "[resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointNameForCache'))]"
                                    ]
                                }
                            ],
                            "dependsOn": [
                                "[concat('Microsoft.Cache/Redis/', parameters('cacheName'))]"
                            ]
                        },
                        {
                            "name": "[parameters('cacheName')]",
                            "type": "Microsoft.Cache/Redis",
                            "location": "[parameters('location')]",
                            "apiVersion": "[variables('cacheApiVersion')]",
                            "tags": {},
                            "properties": {
                                "sku": {
                                    "name": "Basic",
                                    "family": "C",
                                    "capacity": "0"
                                },
                                "redisConfiguration": {},
                                "enableNonSslPort": false,
                                "redisVersion": "6",
                                "publicNetworkAccess": "Disabled"
                            }
                        }
                    ]
                }
            },
            "dependsOn": [
                "[concat('Microsoft.Resources/deployments', '/', variables('vnetResourcesDeployment'))]"
            ]
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('resourcesDeploymentApiVersion')]",
            "name": "[variables('appServiceResourcesDeployment')]",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "apiVersion": "[variables('appServicesApiVersion')]",
                            "name": "[parameters('hostingPlanName')]",
                            "type": "Microsoft.Web/serverfarms",
                            "location": "[parameters('location')]",
                            "kind": "linux",
                            "tags": null,
                            "properties": {
                                "name": "[parameters('hostingPlanName')]",
                                "workerSize": "[parameters('workerSize')]",
                                "workerSizeId": "[parameters('workerSizeId')]",
                                "numberOfWorkers": "[parameters('numberOfWorkers')]",
                                "reserved": true
                            },
                            "sku": {
                                "Tier": "[parameters('sku')]",
                                "Name": "[parameters('skuCode')]"
                            }
                        },
                        {
                            "apiVersion": "[variables('sitesApiVersion')]",
                            "name": "[parameters('name')]",
                            "type": "Microsoft.Web/sites",
                            "location": "[parameters('location')]",
                            "tags": null,
                            "dependsOn": [
                                "[concat('Microsoft.Web/serverfarms/', parameters('hostingPlanName'))]"
                            ],
                            "properties": {
                                "name": "[parameters('name')]",
                                "siteConfig": {
                                    "linuxFxVersion": "[parameters('linuxFxVersion')]",
                                    "appSettings": [],
                                    "vnetRouteAllEnabled": true,
                                    "ftpsState": "[parameters('ftpsState')]"
                                },
                                "serverFarmId": "[concat('/subscriptions/', parameters('subscriptionId'),'/resourcegroups/', parameters('serverFarmResourceGroup'), '/providers/Microsoft.Web/serverfarms/', parameters('hostingPlanName'))]",
                                "clientAffinityEnabled": false,
                                "autoGeneratedDomainNameLabelScope": "[parameters('autoGeneratedDomainNameLabelScope')]"
                            }
                        },
                        {
                            "condition": "[parameters('isVnetEnabled')]",
                            "type": "Microsoft.Resources/deployments",
                            "apiVersion": "[variables('resourcesDeploymentApiVersion')]",
                            "name": "[concat(variables('appServiceResourcesDeployment'), '-vnet')]",
                            "properties": {
                                "mode": "Incremental",
                                "template": {
                                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                    "contentVersion": "1.0.0.0",
                                    "parameters": {},
                                    "variables": {},
                                    "resour